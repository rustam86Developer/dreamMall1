/*! BBCore 2019-10-24 */
function BBCore(e){this.userEmail="",this.userId="",this.clientId="",this.accessToken="",this.currentVideoId=null,this.email=null,this.apiServer=null,this.credentials={clientIdentifier:null,redirectUri:null,clientSecret:null,type:"implicit"},this.onerror=null,this.__mergeProperties(null,e),this.authenticated=!1,this.hasContext=!1,this.storage=localStorage||window.storage,this.CONTENT={QUICKSEND:""},this.lastresponse="",this.__vidRecording=!1,this.__vidRecHndl=null,this.contacts=function(){},this.contacts.prototype=Object.create(Array.prototype),this.contacts.constructor=this.contacts,this.contacts.prototype.add=function(e){return this.push(e),this},this.contacts.prototype.find=function(e,t){for(var o in this)if(this.hasOwnProperty(o)&&o[e]===t)return o;return null},this.contacts.prototype.get=function(e){return this.find("id",e)},this.videos=function(){},this.videos.prototype=Object.create(Array.prototype),this.videos.constructor=this.videos,this.videos.prototype.add=function(e){return this.push(e),this},this.accessToken&&this.validateAccessToken(),this.email&&this.password&&this.login(this.email,this.password)}function responseSuccess(e,t){}"function"!=typeof Object.create&&(Object.create=function(e,t){if("object"!=typeof e&&"function"!=typeof e)throw new TypeError("Object prototype may only be an Object: "+e);if(null===e)throw new Error("This browser's implementation of Object.create is a shim and doesn't support 'null' as the first argument.");if(void 0!==t)throw new Error("This browser's implementation of Object.create is a shim and doesn't support a second argument.");function o(){}return o.prototype=e,new o}),BBCore.CONFIG={VERSION:"1.0",API_END_POINT:"/app/api/api.php",SERVER_API_URL:"https://app.bombbomb.com",OAUTH_STORAGE:"authToken"},BBCore.prototype.__mergeProperties=function(e,t){for(var o in e||(e=this),t)o&&t.hasOwnProperty(o)&&(e[o]=e[o]&&"object"==typeof e[o]?this.__mergeProperties(e[o],t[o]):t[o]);return e},BBCore.prototype.onError=function(e,t){"function"==typeof e?this.onerror=e:this.onerror&&this.onerror.call(this,e,t)},BBCore.prototype.ver=function(){return BBCore.CONFIG.VERSION},BBCore.prototype.getServerUrl=function(){return this.apiServer||BBCore.CONFIG.SERVER_API_URL},BBCore.prototype.getRequestUrl=function(){return this.getServerUrl()+BBCore.CONFIG.API_END_POINT},BBCore._addParameterToUrl=function(e,t,o){var i="?";return-1!==e.indexOf("?")&&(i="&"),e+i+t+"="+o},BBCore.prototype.sendRequest=function(t,o,i,n){if("function"==typeof o&&(i=o),"object"==typeof t&&(o=t),"object"==typeof t&&o.method&&(t=o.method),"string"!=typeof t||o.method||(o.method=t),"IsValidLogin"===t||o.api_key||(o.api_key=this.getKey()),"ValidateSession"!==t&&"authorization_code"!==o.grant_type&&!this.authenticated)return this.onError.call(this,{status:"failure",methodName:"InvalidSession",info:{errormsg:"Invalid login"}},null),!1;var e={},r=this,s=!0;void 0!==o.async&&(s=o.async);var d=this.getOAuthTokenForRequest();d&&d.length?(e.Authorization=d,void 0!==o.api_key&&delete o.api_key):this.isAccessToken(o.api_key)&&(e.Authorization=o.api_key,delete o.api_key);var a=o.url?o.url:this.getRequestUrl();return a=BBCore._addParameterToUrl(a,"xsrc","bbcore-"+BBCore.CONFIG.VERSION),jQuery.ajax({url:a,async:s,type:"post",dataType:"json",crossDomain:!0,data:o,headers:e,success:function(e){r.lastresponse=e.status,"success"===e.status?("GetVideoGuid"===t&&e.info&&e.info.video_id&&(r.currentVideoId=e.info.video_id),i&&i.call(r,e)):"authorization_code"===o.grant_type||"refresh_token"===o.grant_type?i.call(r,e):r.onError.call(r,e)},error:function(e){var t={status:"unknown",jqXHR:e};void 0!==e.responseJSON&&(t=e.responseJSON),r.lastresponse=t.status,"success"===t.status?i.call(r,t,e):r.onError.call(r,t,e),n&&n(r,t)}})},BBCore.prototype.login=function(e,t,o){if(arguments.length<2&&this.credentials&&this.credentials.clientIdentifier){var i=window;"undefined"!=typeof usePopup&&(i=window.open("about:blank","_blank")),i.location=this.getOAuthUrl()}else{if("function"==typeof e&&(o=e,e=this.storage.getItem("b2-uid"),t=this.storage.getItem("b2-pwd")),!e&&!this.accessToken)return void this.onError({info:{errormsg:"Username cannot be blank"}});this.userEmail=e;var n=this;this.sendRequest({method:"ValidateSession",email:e,pw:t,jwt:!0},function(e){n.__updateSession(e,o)})}},BBCore.prototype.logout=function(){this.clearJsonWebToken(),this.clearOAuthToken(),this.clearKey(),this.storage.removeItem("b2-uid"),this.storage.removeItem("b2-pwd"),this.accessToken="",this.hasContext=!1,this.authenticated=!1},BBCore.prototype.credentialsSaved=function(){return null!==this.storage.getItem("b2-uid")||null!==this.storage.getItem("access_token")||null!==this.storage.getItem("jsonWebToken")||null!==localStorage.getItem("authToken")},BBCore.prototype.saveCredentials=function(e,t){this.storage.setItem("b2-uid",e)},BBCore.prototype.validateSession=function(t,e){var o=this.getOAuthPayload(),i=this,n=/[\?\#].*&*(access_token|code)=([^&]+)/gi.exec(window.location);if(n&&1<n.length){var r=n[2];if("code"===n[1])this.validateOAuthCode(decodeURIComponent(r),function(e){this.storeOAuthTokens(e),window.location.href="?code"===n[0].substr(0,5)?window.location.href.replace("?code="+r,""):window.location.href.replace("&code="+n[1],"")},e);else{for(var s={access_token:r,token_type:null,expires_in:null},d=window.location.hash.replace("access_token="+r,""),a=null;a=/\&*(token_type|expires_in)=([^&]+)/gi.exec(window.location.hash);)s[a[1]]=a[2],d=d.replace(a[0],""),window.location.hash=1<d.length?d:"";this.authenticated=!0,this.storeOAuthTokens(s),t.call(i)}}else if(this.isOAuthTokenValid(o)){var c=this.__getOAuthAccessPayload(o);this.__updateSession({status:"success",info:{clientId:c.bbcid,userId:c.sub}},function(){t.call(i)})}else!this.getKey()&&this.getJsonWebToken()?this.verifyJsonWebToken(function(e){i.__updateSession(e),t.call(i,e)}):this.credentials&&this.credentials.clientIdentifier?e&&e():this.getKey()?this.validateAccessToken(t):this.storage.getItem("b2-uid")?this.login(t):e&&e()},BBCore.prototype.getOAuthUrl=function(){var e=null,t=this.credentials;return t.clientIdentifier&&t.redirectUri&&(e=this.getServerUrl()+"/auth/authorize?client_id="+t.clientIdentifier+"&scope="+encodeURIComponent(t.scope?t.scope:"all:manage")+"&redirect_uri="+encodeURIComponent(t.redirectUri)+"&response_type="+("implicit"===t.type?"token":"code")),e},BBCore.prototype.resumeStoredSession=BBCore.prototype.validateSession,BBCore.prototype.validateAccessToken=function(t){var o=this;this.sendRequest({method:"ValidateSession",api_key:this.accessToken,async:!1,jwt:!0},function(e){o.__updateSession(e,t)})},BBCore.prototype.isAccessToken=function(e){return"string"==typeof e&&32<e.length&&-1<e.indexOf(".")},BBCore.prototype.isAuthenticated=function(){return this.authenticated||console.log("You must authenticate a BombBomb session before making additional calls."),this.authenticated},BBCore.prototype.invalidateSession=function(){try{this.logout()}catch(e){return!1}return!0},BBCore.prototype.__updateSession=function(e,t){"success"===e.status&&(e.info.userId?(this.userId=e.info.userId,this.clientId=e.info.clientId):(this.userId=e.info.user_id,this.clientId=e.info.client_id),e.info.api_key&&(this.accessToken=e.info.api_key),this.hasContext=!0,this.authenticated=!0,this.storeKey(this.accessToken),this.storeJsonWebToken(e.info.jwtoken),console.log("bbcore: __updateSession session updated."),t&&t.call(this,e))},BBCore.prototype.verifyKey=function(e,t){this.sendRequest({method:"GetEmails",api_key:e},function(e){t&&t({isValid:"success"===e.status})})},BBCore.prototype.storeKey=function(e){e&&(this.accessToken=e,this.storage.setItem("access_token",this.accessToken))},BBCore.prototype.getKey=function(){return this.accessToken?this.accessToken:this.storage.getItem("access_token")},BBCore.prototype.clearKey=function(){this.accessToken=null,this.storage.removeItem("access_token")},BBCore.prototype.verifyJsonWebToken=function(e,t){"function"==typeof e&&(t=e,e=this.getJsonWebToken()),this.sendRequest({method:"ValidateJsonWebToken",jwt:e},function(e){t&&(e.isValid="success"===e.status,t(e))})},BBCore.prototype.storeOAuthTokens=function(e){if(e)try{e="string"==typeof e?e:JSON.stringify(e),this.storage.setItem(BBCore.CONFIG.OAUTH_STORAGE,btoa(e))}catch(e){}},BBCore.prototype.getOAuthPayload=function(){var e=this.storage.getItem(BBCore.CONFIG.OAUTH_STORAGE);return e?atob(e):null},BBCore.prototype.getOAuthTokenForRequest=function(){var e=null;try{var t=this.getOAuthPayload();if(t&&this.isOAuthTokenValid(t)){var o=JSON.parse(t);"object"==typeof o&&(e=o.token_type.substr(0,1).toUpperCase()+o.token_type.substr(1)+" "+o.access_token)}}catch(e){console.error("Exception occurred retrieving OAuth Token for Request",e)}return e},BBCore.prototype.clearOAuthToken=function(){this.authenticated=!1,this.storage.removeItem(BBCore.CONFIG.OAUTH_STORAGE)},BBCore.prototype.__getOAuthAccessPayload=function(e){var t="string"==typeof e?JSON.parse(e):e,o=null;if(t)try{var i=t.access_token.split(".");2<i.length&&(o=JSON.parse(atob(i[1])))}catch(e){console.warn("Exception __getOAuthAccessPayload fetching access_token payload",e)}return o},BBCore.prototype.isOAuthTokenValid=function(e){var t=!1;try{var o=this.__getOAuthAccessPayload(e);o&&new Date(o.exp)<Date.now()&&(t=!0)}catch(e){console.warn("Exception while validating OAuthToken",e)}return t},BBCore.prototype.validateOAuthCode=function(e,t,o){var i=this,n=this.credentials,r={url:this.getServerUrl()+"/auth/access_token",grant_type:n.type||"implicit",client_id:n.clientIdentifier,redirect_uri:n.redirectUri,code:JSON.stringify(e)};if("implicit"!==n.type){if(!n.clientSecret||!n.clientSecret){var s="Client Secret required when making "+n.type+" grant requests";return console.warn(s),void o.call(this,s)}r.client_secret=n.clientSecret}this.sendRequest(r,function(e){e&&this.isOAuthTokenValid(e)?(this.authenticated=!0,this.storeOAuthTokens(e),t&&t.call(i)):o&&o.call(i)})},BBCore.prototype.refreshOAuthToken=function(t){var e=this.credentials,o={url:this.getServerUrl()+"/auth/access_token",grant_type:"refresh_token",refresh_token:this.getOAuthRefreshToken(),client_id:e.clientIdentifier,client_secret:e.clientSecret,redirect_uri:e.redirectUri,code:JSON.stringify(authCode)};this.sendRequest(o,function(e){console.log("got refresh auth back",e),e&&(this.isOAuthTokenValid(e)&&(this.authenticated=!0),this.storeOAuthTokens(e),t&&t())})},BBCore.prototype.storeJsonWebToken=function(e){e&&(this.jsonWebToken=e,this.storage.setItem("jsonWebToken",this.jsonWebToken))},BBCore.prototype.getJsonWebToken=function(){return this.jsonWebToken?this.jsonWebToken:this.storage.getItem("jsonWebToken")},BBCore.prototype.clearJsonWebToken=function(){this.jsonWebToken=null,this.storage.removeItem("jsonWebToken")},BBCore.prototype.getValidJsonWebTokenAsync=function(o){var e=this.getJsonWebToken();e||!o?this.verifyJsonWebToken(e,function(t){t&&t.isValid?o&&o(e):this.validateAccessToken(function(e){o&&(t?(this.storeJsonWebToken(e.jwtoken),o(this.getJsonWebToken())):o(null))})}):o(null)},BBCore.prototype.getLists=function(e){this.sendRequest({method:"GetLists"},e)},BBCore.prototype.createList=function(e,t){this.sendRequest({method:"createList",name:e},t)},BBCore.prototype.getContact=function(e,t){if(e){var o=jQuery.extend({},{width:340,force_ssl:!1},{contact_id:e,method:"GetContact"});this.sendRequest(o,t)}},BBCore.prototype.getListContacts=function(e,t){e&&this.sendRequest({method:"GetListContacts",list_id:e},t)},BBCore.prototype.addContact=function(e,t){"object"==typeof e&&(e.method="AddContact",this.sendRequest(e,t))},BBCore.prototype.bulkAddContacts=function(e,t){e||(e={}),e.method="BulkAddContacts","object"==typeof e.contacts&&(e.contacts=JSON.stringify(e.contacts)),this.sendRequest(e,t)},BBCore.prototype.updateContact=function(e,t){e&&(e.method="UpdateContact",this.sendRequest(e,t))},BBCore.prototype.getImportAddressesByType=function(e,t){(e=jQuery.extend({method:"getImportAddressesByType"},e)).type||this.onError({info:{errmsg:["A Type must be provided."]}}),this.sendRequest(e,t)},BBCore.prototype.addContactImportAddress=function(e,t){(e=jQuery.extend({method:"addContactImportAddress"},e)).importAddrCode&&e.importAddrName||this.onError({info:{errmsg:["An Import Address Code and Import Address Name must be provided."]}}),this.sendRequest(e,t)},BBCore.prototype.deleteContactImportAddress=function(e,t){(e=jQuery.extend({importAddrCode:1,method:"deleteContactImportAddress"},e)).importAddrCode||this.onError({info:{errmsg:["Invalid Import Address Code"]}}),this.sendRequest(e,t)},BBCore.prototype.getClientRecentInteractions=function(e,t){(e=e||{}).activitySince=e.activitySince||"",e.method="GetClientRecentInteractions",this.sendRequest(e,t)},BBCore.prototype.getEmails=function(e){this.sendRequest({method:"GetEmails"},e)},BBCore.prototype.sendCustomVideoEmail=function(e,t){var o=jQuery.extend({},{method:"SendCustomVideoEmail",html_content:null,subject:"",email:"",email_id:"",from_name:""},e);this.sendRequest(o,t)},BBCore.prototype.getDrips=function(e,t){(e=e||{}).method="GetDrips",this.sendRequest(e,t)},BBCore.prototype.getForms=function(e,t){(e=e||{}).method="GetForms",this.sendRequest(e,t)},BBCore.prototype.getClientIntegrations=function(e,t){"function"==typeof e&&(t=e,e={}),e.method="getClientIntegrations",this.sendRequest(e,t)},BBCore.contact=function(e){for(var t in this.email="",this.firstname="",this.lastname="",this.phone="",this.phone_number="",this.address_line_1="",this.address_line_2="",this.city="",this.state="",this.country="",this.postal_code="",this.company="",this.position="",this.comments="",this.listlist="",this.id="",e)e.hasOwnProperty(t)&&(this[t]=e[t]);this.eml=this.email},BBCore.video=function(e){for(var t in this.vid_id="",this.title="",this.filename="",e)e.hasOwnProperty(t)&&(this[t]=e[t])},BBCore.prototype.getVideoDeliveryUrl=function(e){return e=jQuery.extend({video_id:"",autoplay:1},e),"http://"+(0<this.getServerUrl().indexOf("dev")?"dev.":0<this.getServerUrl().indexOf("local")?"local.":"")+"bbemaildelivery.com/bbext/?p=video_land&id="+e.video_id+"&autoplay="+e.autoplay},BBCore.prototype.getVideo=function(e,t){e&&this.sendRequest({method:"GetVideos",video_id:e},t)},BBCore.prototype.getVideos=function(e,t){"function"==typeof e&&(t=e,e={});var o=jQuery.extend({},{updatedSince:"",page:null,pageSize:50},e);if("object"==typeof o&&null!=o&&void 0!==o.pageSize&&(null==o.pageSize||o.pageSize<=0||isNaN(o.pageSize)))return!1;o.method="GetVideos",null!==o.page&&o.pageSize&&(o.method="GetVideosPaged"),this.sendRequest(o,t)},BBCore.prototype.getVideoStatus=function(e,t){e&&this.sendRequest({method:"getVideoStatus",id:e},t)},BBCore.prototype.getEncodingReport=function(e,t){e&&this.sendRequest({method:"getEncodingReport",id:e},t)},BBCore.prototype.deleteVideo=function(e,t){this.sendRequest({method:"DeleteVideo",video_id:e},t)},BBCore.prototype.setVideoId=function(e){this.currentVideoId=e},BBCore.prototype.getVideoId=function(e){this.currentVideoId?e&&e.call(this,this.currentVideoId):this.getNewVideoGuid(e)},BBCore.prototype.hasVideoId=function(){return!!this.currentVideoId},BBCore.prototype.getNewVideoGuid=function(t){var o=this;this.sendRequest({method:"GetVideoGuid"},function(e){o.currentVideoId=e.info.video_id,t&&t.call(this,o.currentVideoId)})},BBCore.prototype.videoQuickSend=function(t,o){var e={method:"VideoQuickSend",subject:"QuickSend from BombBomb",mobile_message:"",email_address:null,videoId:null},i=[];for(var n in e)e.hasOwnProperty(n)&&(t[n]||(t[n]=e[n]));t.message&&!t.mobile_message&&(t.mobile_message=t.message),t.email&&!t.email_address&&(t.email_address=t.email),t.email_address&&!t.email_addresses&&(t.email_addresses=t.email_address),!t.video_id&&this.currentVideoId&&(t.video_id=this.currentVideoId),t.video_id||i.push("quickSendVideo Error: no video_id defined."),t.email_addresses||i.push("quickSendVideo Error: no email_address defined."),0<i.length&&!t.video_id?this.getVideoId(function(e){e?(t.video_id=e,this.sendRequest(t,o)):(i.push("quickSendVideo: Terminal Error: Unable to set video_id"),this.onError({info:{errmsg:i}}))}):this.sendRequest(t,o)},BBCore.prototype.getEmbeddedRecorderUrl=function(i,n){"function"==typeof i&&(n=i,i={});void 0===i.height&&(i=jQuery.extend({},{height:240,width:320,force_ssl:!1},i||{}));var r=jQuery.extend({},i,{module:"videos",page:"EmbeddedRecorder",popup:1,nohtml:1}),s=this;this.getVideoId(function(o){var e=s.getServerUrl()+"/app/?",t=s.getKey();ignoreLegacyToken=i.ignoreLegacyToken||!1,t&&t.length&&!ignoreLegacyToken?(e+="module=login&actn=login&api_key="+(r.api_key=t)+"&redir="+btoa(e+jQuery.param(r)+(o?"&vguid="+o:"")),n.call(this,{url:e,video_id:o})):(i.videoId=o,this.getVideoRecorder(i,function(e){var t="";e&&e.info&&e.info.content.length&&(t=/https*:\/\/[^<"]+/.exec(e.info.content)[0]);n({url:t,video_id:o})}))})},BBCore.prototype.getVideoRecorder=function(e,t){"function"==typeof e&&(t=e,e=null);mergedOpts=jQuery.extend({height:240,width:320,force_ssl:!1,start:null,stop:null,recorded:null},e),this.isAuthenticated()?(mergedOpts.method="GetVideoRecorder",this.sendRequest(mergedOpts,function(e){t&&t.call(this,e)})):this.onError({message:"Must authenticate session before invoking methods."})},BBCore.prototype.startVideoRecorder=function(t,o){"function"==typeof t&&(o=t,t=null),(t=t||{type:"embedded",target:null,height:240,width:320,force_ssl:!1,recorderLoaded:null,recordComplete:o}).recordComplete&&!o&&(o=t.recordComplete),this.__vidRecHndl=t.target?jQuery(t.target):jQuery("body").append('<div id="b2recorder"></div>');var e=jQuery.extend({},t);delete e.type,delete e.target,delete e.recordComplete,delete e.recorderLoaded;var i=this;this.getVideoRecorder(e,function(e){!i.currentVideoId&&e.info.vid_id&&(i.currentVideoId=e.info.vid_id),console.log("startVideoRecorder :"+i.currentVideoId),i.__vidRecHndl.html(e.info.content),t.recorderLoaded&&t.recorderLoaded.call(i,e.info)}),window.bbStreamStartRecord=function(e,t){console.log("bbStreamStartRecord triggered"),i.liveStreamStartRecord.call(i,e,t)},window.bbStreamStopRecord=function(e){console.log("bbStreamStopRecord triggered"),i.liveStreamStopRecord.call(i,e)},window.reportVideoRecorded=function(e,t){console.log("reportVideoRecorded triggered"),o({videoId:i.currentVideoId,filename:e,log:t})}},BBCore.prototype.destroyVideoRecorder=function(){void 0!==this.__vidRecHndl&&this.__vidRecHndl.remove(),window.bbStreamStartRecord=null,window.bbStreamStopRecord=null,window.reportVideoRecorded=null},BBCore.prototype.liveStreamStartRecord=function(e,t){this.__vidRecording=!0,this.sendRequest({method:"liveStreamStartRecord",streamname:e,filename:t})},BBCore.prototype.liveStreamStopRecord=function(e){this.__vidRecording=!1,this.sendRequest({method:"liveStreamStopRecord",streamname:e})},BBCore.prototype.saveRecordedVideo=function(e,t,o,i){var n=t||this.currentVideoId,r=this;this.sendRequest({method:"VideoRecordedLive",title:e,filename:o,vid_id:n},function(e){i.call(r,e)})},BBCore.prototype.saveRecording=function(e){var t=e;t.vid_id&&this.sendRequest({method:"VideoRecordedLive"},t,function(){})};